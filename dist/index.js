var t={id:"sso",handler:(t,{env:e,logger:o})=>{const n=e.KEYCLOAK_URL||"http://keycloak:8080",r=e.KEYCLOAK_REALM||"testing",i=e.KEYCLOAK_ADMIN_USER||"admin",a=e.KEYCLOAK_ADMIN_PASSWORD||"admin",s=e.PUBLIC_URL||"http://localhost:8055",c=e.MOBILE_APP_SCHEME||"portalpipq",d=e.MOBILE_APP_CALLBACK_PATH||"/auth/callback",l=e.GOOGLE_CALLBACK_PATH||"/auth/callback/google",u=e.KEYCLOAK_CLIENT_ID||"admin-cli",g=e.COOKIE_DOMAIN||null,f="false"!==e.COOKIE_SECURE,h=e.COOKIE_SAME_SITE||"lax";o.info("üöÄ Mobile Auth Proxy Extension loaded"),o.info("üîê Keycloak URL: "+n),o.info("üåê Keycloak Realm: "+r),o.info("üì± Mobile App Scheme: "+c+"://"+d),o.info("üîµ Google OAuth enabled"),t.get("/health",(t,e)=>{e.json({status:"ok",service:"directus-mobile-auth-proxy"})}),t.get("/mobile-callback",async(t,e)=>{o.info("üì± Mobile callback received"),o.info("Cookies: "+JSON.stringify(t.cookies)),o.info("Query: "+JSON.stringify(t.query));try{const n=t.cookies.directus_session_token;if(!n)return o.error("‚ùå No session token found in cookies"),e.send(`\n\t\t\t\t\t<html>\n\t\t\t\t\t\t<body>\n\t\t\t\t\t\t\t<h2>Authentication Failed</h2>\n\t\t\t\t\t\t\t<p>No session token found. Please try logging in again.</p>\n\t\t\t\t\t\t\t<a href="${s}/auth/login/keycloak">Try Again</a>\n\t\t\t\t\t\t</body>\n\t\t\t\t\t</html>\n\t\t\t\t`);o.info("‚úÖ Session token found: "+n.substring(0,20)+"...");const r=await fetch(`${s}/users/me`,{headers:{Cookie:`directus_session_token=${n}`}});if(!r.ok)throw new Error("Failed to get user info: "+await r.text());const i=await r.json(),a=i.data.id,l=i.data.email;o.info("üë§ User authenticated: "+a+", "+l);const u=n;if(o.info("üé´ Using session token as access token"),isBrowser){o.info("üåê Browser request detected - maintaining session"),e.cookie("directus_session_token",n,{httpOnly:!0,secure:f,domain:g,sameSite:h,maxAge:6048e5,path:"/"});const r=t.query.redirect_uri||t.query.redirect||"/";return o.info("üîÑ Redirecting browser to: "+r),e.redirect(r)}const p=new URL(`${c}://${d}`);p.searchParams.set("access_token",u),p.searchParams.set("user_id",a),p.searchParams.set("email",l||""),o.info("üîÑ Redirecting to app: "+p.toString()),e.redirect(p.toString())}catch(t){o.error("‚ùå Error in callback:",t),e.status(500).send(`\n\t\t\t\t<html>\n\t\t\t\t\t<body>\n\t\t\t\t\t\t<h2>Error</h2>\n\t\t\t\t\t\t<p>${t.message}</p>\n\t\t\t\t\t\t<a href="${s}/auth/login/keycloak">Try Again</a>\n\t\t\t\t\t</body>\n\t\t\t\t</html>\n\t\t\t`)}}),t.get("/google-callback",async(t,e)=>{const n=function(t){if("browser"===t.query.type)return!0;if("mobile"===t.query.type)return!1;const e=t.headers["user-agent"]||"";return/Mozilla|Chrome|Safari|Firefox|Edge|Opera/i.test(e)&&!/Mobile.*App|ReactNative|Expo/i.test(e)}(t);o.info(`${n?"üåê":"üì±"} ${n?"Browser":"Mobile"} Google callback received`),o.info("Cookies: "+JSON.stringify(t.cookies)),o.info("Query: "+JSON.stringify(t.query));try{const r=t.cookies.directus_session_token;if(!r)return o.error("‚ùå No session token found in cookies"),e.send("\n\t\t\t\t\t\t<html>\n\t\t\t\t\t\t\t<head>\n\t\t\t\t\t\t\t\t<title>Authentication Failed</title>\n\t\t\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t\t\tbody { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; \n\t\t\t\t\t\t\t\t\t       padding: 40px; text-align: center; background: #f5f5f5; }\n\t\t\t\t\t\t\t\t\t.container { max-width: 500px; margin: 0 auto; background: white; \n\t\t\t\t\t\t\t\t\t           padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n\t\t\t\t\t\t\t\t\th2 { color: #e74c3c; }\n\t\t\t\t\t\t\t\t\ta { display: inline-block; margin-top: 20px; padding: 10px 20px; \n\t\t\t\t\t\t\t\t\t    background: #4285f4; color: white; text-decoration: none; border-radius: 4px; }\n\t\t\t\t\t\t\t\t\ta:hover { background: #357ae8; }\n\t\t\t\t\t\t\t\t</style>\n\t\t\t\t\t\t\t</head>\n\t\t\t\t\t\t\t<body>\n\t\t\t\t\t\t\t\t<div class=\"container\">\n\t\t\t\t\t\t\t\t\t<h2>Authentication Failed</h2>\n\t\t\t\t\t\t\t\t\t<p>No session token found. Please close this and try logging in again.</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</body>\n\t\t\t\t\t\t</html>\n\t\t\t\t\t");o.info("‚úÖ Session token found: "+r.substring(0,20)+"...");const i=await fetch(`${s}/users/me`,{headers:{Cookie:`directus_session_token=${r}`}});if(!i.ok)throw new Error("Failed to get user info: "+await i.text());const a=await i.json(),d=a.data.id,u=a.data.email,p=a.data.first_name||a.data.email;o.info("üë§ User authenticated via Google: "+d+", "+u);const m=r;if(o.info("üé´ Using session token as access token"),n){o.info("üåê Browser request detected - maintaining session"),e.cookie("directus_session_token",r,{httpOnly:!0,secure:f,domain:g,sameSite:h,maxAge:6048e5,path:"/"});const n=t.query.redirect_uri||t.query.redirect||"/";return o.info("üîÑ Redirecting browser to: "+n),e.send(`\n\t\t\t\t\t\t<html>\n\t\t\t\t\t\t\t<head>\n\t\t\t\t\t\t\t\t<title>Login Successful</title>\n\t\t\t\t\t\t\t\t<meta http-equiv="refresh" content="2;url=${n}">\n\t\t\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t\t\tbody { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; \n\t\t\t\t\t\t\t\t\t       padding: 40px; text-align: center; background: #f5f5f5; }\n\t\t\t\t\t\t\t\t\t.container { max-width: 500px; margin: 0 auto; background: white; \n\t\t\t\t\t\t\t\t\t           padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n\t\t\t\t\t\t\t\t\th2 { color: #27ae60; }\n\t\t\t\t\t\t\t\t\t.checkmark { font-size: 48px; color: #27ae60; margin-bottom: 20px; }\n\t\t\t\t\t\t\t\t\tp { color: #666; margin: 10px 0; }\n\t\t\t\t\t\t\t\t\t.spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4285f4; \n\t\t\t\t\t\t\t\t\t          border-radius: 50%; width: 40px; height: 40px; \n\t\t\t\t\t\t\t\t\t          animation: spin 1s linear infinite; margin: 20px auto; }\n\t\t\t\t\t\t\t\t\t@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }\n\t\t\t\t\t\t\t\t\ta { color: #4285f4; text-decoration: none; }\n\t\t\t\t\t\t\t\t\ta:hover { text-decoration: underline; }\n\t\t\t\t\t\t\t\t\t.google-icon { color: #4285f4; margin-right: 5px; }\n\t\t\t\t\t\t\t\t</style>\n\t\t\t\t\t\t\t</head>\n\t\t\t\t\t\t\t<body>\n\t\t\t\t\t\t\t\t<div class="container">\n\t\t\t\t\t\t\t\t\t<div class="checkmark">‚úì</div>\n\t\t\t\t\t\t\t\t\t<h2><span class="google-icon">üîµ</span>Google Login Successful!</h2>\n\t\t\t\t\t\t\t\t\t<p>Welcome, ${p}!</p>\n\t\t\t\t\t\t\t\t\t<p>Your session has been saved. You can now access other services using the same login.</p>\n\t\t\t\t\t\t\t\t\t<div class="spinner"></div>\n\t\t\t\t\t\t\t\t\t<p style="margin-top: 20px;">Redirecting you automatically...</p>\n\t\t\t\t\t\t\t\t\t<p style="font-size: 14px; margin-top: 20px;">\n\t\t\t\t\t\t\t\t\t\t<a href="${n}">Click here if not redirected automatically</a>\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</body>\n\t\t\t\t\t\t</html>\n\t\t\t\t\t`)}o.info("üì± Mobile app request - redirecting with token");const k=new URL(`${c}://${l}`);k.searchParams.set("access_token",m),k.searchParams.set("user_id",d),k.searchParams.set("email",u||""),k.searchParams.set("provider","google"),o.info("üîÑ Redirecting to app (Google): "+k.toString()),e.redirect(k.toString())}catch(t){o.error("‚ùå Error in Google callback:",t),e.status(500).send(`\n\t\t\t\t\t<html>\n\t\t\t\t\t\t<head>\n\t\t\t\t\t\t\t<title>Error</title>\n\t\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t\tbody { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; \n\t\t\t\t\t\t\t\t       padding: 40px; text-align: center; background: #f5f5f5; }\n\t\t\t\t\t\t\t\t.container { max-width: 500px; margin: 0 auto; background: white; \n\t\t\t\t\t\t\t\t           padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n\t\t\t\t\t\t\t\th2 { color: #e74c3c; }\n\t\t\t\t\t\t\t\t.error-icon { font-size: 48px; color: #e74c3c; margin-bottom: 20px; }\n\t\t\t\t\t\t\t\tpre { background: #f8f8f8; padding: 15px; border-radius: 4px; \n\t\t\t\t\t\t\t\t      text-align: left; overflow-x: auto; font-size: 12px; }\n\t\t\t\t\t\t\t\ta { display: inline-block; margin-top: 20px; padding: 10px 20px; \n\t\t\t\t\t\t\t\t    background: #4285f4; color: white; text-decoration: none; border-radius: 4px; }\n\t\t\t\t\t\t\t\ta:hover { background: #357ae8; }\n\t\t\t\t\t\t\t</style>\n\t\t\t\t\t\t</head>\n\t\t\t\t\t\t<body>\n\t\t\t\t\t\t\t<div class="container">\n\t\t\t\t\t\t\t\t<div class="error-icon">‚ö†Ô∏è</div>\n\t\t\t\t\t\t\t\t<h2>Error</h2>\n\t\t\t\t\t\t\t\t<p>An error occurred during Google authentication:</p>\n\t\t\t\t\t\t\t\t<pre>${t.message}</pre>\n\t\t\t\t\t\t\t\t<a href="${s}/auth/login/google">Try Again</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</body>\n\t\t\t\t\t</html>\n\t\t\t\t`)}}),t.post("/mobile-logout",async(t,e)=>{o.info("üö™ Logout request received");try{const c=t.headers.authorization,d=c?.replace("Bearer ","");if(!d)return e.status(400).json({error:"No token provided",message:"Authorization header with Bearer token is required"});o.info("üé´ Token received: "+d.substring(0,20)+"...");let l=null;try{const t=await fetch(`${s}/users/me`,{headers:{Authorization:`Bearer ${d}`}});if(t.ok){l=(await t.json()).data.email,o.info("üë§ User email: "+l)}}catch(t){o.error("‚ö†Ô∏è Error getting user info: "+t.message)}try{const t=await fetch(`${s}/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({refresh_token:d})});t.ok?o.info("‚úÖ Directus session invalidated"):o.info("‚ö†Ô∏è Directus logout response: "+t.status)}catch(t){o.error("‚ö†Ô∏è Error logging out from Directus: "+t.message)}if(l)try{o.info("üîê Getting Keycloak admin token...");const t=await async function(){try{const t=await fetch(`${n}/realms/master/protocol/openid-connect/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"password",client_id:u,username:i,password:a}).toString()});if(!t.ok)throw new Error("Failed to get admin token");return(await t.json()).access_token}catch(t){return o.error("Error getting admin token:",t),null}}();if(t){o.info("üîç Looking up Keycloak user...");const e=await async function(t,e){try{const o=await fetch(`${n}/admin/realms/${r}/users?email=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error("Failed to get user");const i=await o.json();return i.length>0?i[0].id:null}catch(t){return o.error("Error getting user ID:",t),null}}(t,l);if(e){o.info("üö™ Logging out from Keycloak...");const i=await async function(t,e){try{const o=await fetch(`${n}/admin/realms/${r}/users/${e}/logout`,{method:"POST",headers:{Authorization:`Bearer ${t}`}});return o.ok||204===o.status}catch(t){return o.error("Error logging out user from Keycloak:",t),!1}}(t,e);i?o.info("‚úÖ Keycloak sessions terminated"):o.info("‚ö†Ô∏è Failed to logout from Keycloak")}else o.info("‚ö†Ô∏è User not found in Keycloak")}else o.info("‚ö†Ô∏è Failed to get Keycloak admin token")}catch(t){o.error("‚ö†Ô∏è Error logging out from Keycloak: "+t.message)}o.info("üéâ Logout completed"),e.json({success:!0,message:"Logged out successfully from Directus and Keycloak"})}catch(t){o.error("‚ùå Error in logout:",t),e.status(500).json({error:t.message,message:"Failed to logout"})}})}};export{t as default};
